<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rclone Web Generator — Auto‑Resume Agent Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <meta name="description" content="Generate a portable rclone LaunchAgent + auto-resume script for macOS. 15‑min checks, auto‑logout, success notification." />
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useMemo, useState } = React;

    function App() {
      const [remoteName, setRemoteName] = useState("testdrive");
      const [folderId, setFolderId] = useState("");
      const [destPath, setDestPath] = useState("testv2");
      const [startInterval, setStartInterval] = useState(900); // 15 minutes
      const [autoUnload, setAutoUnload] = useState(true);
      const [showNotifications, setShowNotifications] = useState(true);

      const valid = folderId.trim().length > 0 && remoteName.trim().length > 0 && destPath.trim().length > 0;

      const script = useMemo(() => {
        const notifBlock = showNotifications
          ? "\nosascript -e 'display notification \"Google Drive copy finished and verified.\" with title \"rclone shared→local\"'\n"
          : "\n# macOS notification disabled\n";

        return `#!/usr/bin/env bash
set -euo pipefail

# >>> CONFIG (generated) <<<
REMOTE_NAME=\"${remoteName}\"
FOLDER_ID=\"${folderId}\"
DEST_PATH=\"${destPath}\"
AUTO_UNLOAD_AGENT=\"${autoUnload ? "true" : "false"}\"
LAUNCH_LABEL=\"com.rclone.sharedcopy\"
AGENT_PLIST=\"$HOME/Library/LaunchAgents/$LAUNCH_LABEL.plist\"
# <<< CONFIG >>>

STATE_DIR=\"$HOME/Library/Application Support/rclone-resume\"
NEXT_RUN_FILE=\"$STATE_DIR/next_run_epoch\"
LOG=\"$HOME/rclone-copy.log\"
LOCK=\"/tmp/rclone-sharedcopy.lock\"

now_epoch(){ date +%s; }
is_running(){ [[ -e \"$LOCK\" ]] && kill -0 \"$(cat \"$LOCK\")\" 2>/dev/null; }
mark_running(){ echo $$ > \"$LOCK\"; }
clear_running(){ rm -f \"$LOCK\"; }

mkdir -p \"$STATE_DIR\"

# If a copy is already running, exit quietly
if is_running; then exit 0; fi

NEXT_RUN_EPOCH=\"$(cat \"$NEXT_RUN_FILE\" 2>/dev/null || echo 0)\"
NOW=\"$(now_epoch)\"

# Not time yet? exit.
if (( NOW < NEXT_RUN_EPOCH )); then exit 0; fi

mark_running
trap clear_running EXIT

# Keep Mac awake only while running the copy
caffeinate -i rclone copy \\
  \"${remoteName},root_folder_id=${folderId}:\" \\
  \"${remoteName}:${destPath}\" \\
  --progress --fast-list \\
  --checkers=16 --transfers=8 \\
  --tpslimit=10 --tpslimit-burst=10 \\
  --drive-stop-on-upload-limit \\
  --retries 10 --retries-sleep 30s --low-level-retries 50 \\
  --log-file \"$LOG\" --log-level INFO --stats 60s || true

# Check if we're fully done (one-way size-only is fast and sufficient)
if rclone check \\
  \"${remoteName},root_folder_id=${folderId}:\" \\
  \"${remoteName}:${destPath}\" \\
  --one-way --size-only --fast-list \\
  --log-file \"$LOG\" --log-level INFO --stats 60s >/dev/null 2>&1 ; then
  echo \"All done. Cleaning up…\" | tee -a \"$LOG\"
  echo \"SUCCESS: Transfer complete and verified (size-only) at $(date)\" | tee -a \"$LOG\"
  touch \"$STATE_DIR/SUCCESS_$(date +%Y%m%d-%H%M%S).stamp\"
  ${notifBlock}  rclone config disconnect \"${remoteName}:\" || true
  rclone config delete \"${remoteName}\" --auto-confirm 2>/dev/null || true
  rm -f \"$NEXT_RUN_FILE\"
  if [[ \"${autoUnload ? "true" : "false"}\" == \"true\" ]]; then
    launchctl bootout \"gui/$(id -u)\" \"$AGENT_PLIST\" 2>/dev/null || true
  fi
  exit 0
fi

# Not done → schedule next run 24h later
echo $(( NOW + 24*60*60 )) > \"$NEXT_RUN_FILE\"
echo \"Quota hit or more to do. Next run epoch: $(cat \"$NEXT_RUN_FILE\")\" | tee -a \"$LOG\"
exit 0
`;
      }, [remoteName, folderId, destPath, autoUnload, showNotifications]);

      const plist = useMemo(() => {
        return `<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">
<plist version=\"1.0\">
  <dict>
    <key>Label</key>
    <string>com.rclone.sharedcopy</string>
    <key>ProgramArguments</key>
    <array>
      <string>/bin/bash</string>
      <string>-lc</string>
      <string>${"${USER_HOME}"}/bin/rclone-sharedcopy-agent.sh</string>
    </array>
    <key>StartInterval</key><integer>${startInterval}</integer>
    <key>RunAtLoad</key><true/>
    <key>StandardOutPath</key><string>${"${USER_HOME}"}/Library/Logs/rclone-sharedcopy.out</string>
    <key>StandardErrorPath</key><string>${"${USER_HOME}"}/Library/Logs/rclone-sharedcopy.err</string>
  </dict>
</plist>`;
      }, [startInterval]);

      const oneLiner = useMemo(() => {
        const plistInline = plist
          .replaceAll("${USER_HOME}", '"$USER_HOME"')
          .replaceAll("`", "\`");

        const scriptHeredoc = script;

        return `mkdir -p \"$HOME/bin\" \"$HOME/Library/Application Support/rclone-resume\" \"$HOME/Library/LaunchAgents\" \"$HOME/Library/Logs\" && cat > \"$HOME/bin/rclone-sharedcopy-agent.sh\" <<'SH'
${scriptHeredoc}
SH
chmod +x \"$HOME/bin/rclone-sharedcopy-agent.sh\" && USER_HOME=\"$HOME\" && cat > \"$HOME/Library/LaunchAgents/com.rclone.sharedcopy.plist\" <<PLIST
${plistInline}
PLIST
plutil -lint \"$HOME/Library/LaunchAgents/com.rclone.sharedcopy.plist\" && UID=$(id -u) && launchctl bootout gui/$UID \"$HOME/Library/LaunchAgents/com.rclone.sharedcopy.plist\" 2>/dev/null || true && launchctl bootstrap gui/$UID \"$HOME/Library/LaunchAgents/com.rclone.sharedcopy.plist\" && launchctl kickstart -k gui/$UID/com.rclone.sharedcopy`;
      }, [script, plist]);

      const cleanup = useMemo(() => {
        return `launchctl bootout gui/$(id -u) \"$HOME/Library/LaunchAgents/com.rclone.sharedcopy.plist\"
rm -f \"$HOME/Library/LaunchAgents/com.rclone.sharedcopy.plist\"
rm -f \"$HOME/bin/rclone-sharedcopy-agent.sh\"
rm -rf \"$HOME/Library/Application Support/rclone-resume\"
rm -f \"$HOME/Library/Logs/rclone-sharedcopy.out\" \"$HOME/Library/Logs/rclone-sharedcopy.err\"
# Remote cleanup (safe; does not delete Drive files)
rclone config disconnect \"${remoteName}:\" || true
rclone config delete \"${remoteName}\" --auto-confirm || true`;
      }, [remoteName]);

      const copy = async (text) => {
        try {
          await navigator.clipboard.writeText(text);
          alert("Copied to clipboard");
        } catch (e) {
          alert("Copy failed: " + e.message);
        }
      };

      const download = (filename, text) => {
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      return (
        <div className="min-h-screen text-gray-900 p-6">
          <div className="max-w-5xl mx-auto space-y-6">
            <header className="flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold">Rclone Web Generator — Auto‑Resume Agent Builder</h1>
                <p className="text-sm text-gray-600">Generates a portable LaunchAgent + script for any macOS user. 15‑min checks, auto‑resume ~24h, auto‑logout & success notification.</p>
              </div>
            </header>

            <section className="grid md:grid-cols-3 gap-4">
              <div className="md:col-span-1 space-y-3">
                <div>
                  <label className="block text-sm font-medium">Remote name</label>
                  <input value={remoteName} onChange={e=>setRemoteName(e.target.value)} className="mt-1 w-full rounded-xl border p-2" />
                </div>
                <div>
                  <label className="block text-sm font-medium">Folder ID (Google Drive)</label>
                  <input value={folderId} onChange={e=>setFolderId(e.target.value)} className="mt-1 w-full rounded-xl border p-2" placeholder="e.g. 1ruaHakp5SpL7tu6oQDDIwK7etN63Y6-z" />
                </div>
                <div>
                  <label className="block text-sm font-medium">Destination path in your Drive</label>
                  <input value={destPath} onChange={e=>setDestPath(e.target.value)} className="mt-1 w-full rounded-xl border p-2" placeholder="e.g. MyImport/testv2" />
                </div>
                <div>
                  <label className="block text-sm font-medium">Check interval (seconds)</label>
                  <input type="number" min={60} value={startInterval} onChange={e=>setStartInterval(parseInt(e.target.value||"0",10))} className="mt-1 w-full rounded-xl border p-2" />
                  <p className="text-xs text-gray-500 mt-1">Default 900 (15 minutes)</p>
                </div>
                <div className="flex items-center gap-2">
                  <input id="autoUnload" type="checkbox" checked={autoUnload} onChange={e=>setAutoUnload(e.target.checked)} />
                  <label htmlFor="autoUnload" className="text-sm">Auto‑stop agent when finished</label>
                </div>
                <div className="flex items-center gap-2">
                  <input id="notify" type="checkbox" checked={showNotifications} onChange={e=>setShowNotifications(e.target.checked)} />
                  <label htmlFor="notify" className="text-sm">Show macOS notification on success</label>
                </div>
                <button className={`w-full mt-2 rounded-xl p-2 font-medium ${valid?"bg-black text-white":"bg-gray-300 text-gray-600"}`} disabled={!valid} onClick={()=>copy(oneLiner)}>
                  Copy Install One‑liner
                </button>
                <p className="text-xs text-gray-500">Paste the one‑liner into Terminal. It writes files, validates the plist, and starts the LaunchAgent.</p>
              </div>

              <div className="md:col-span-2 space-y-4">
                <div className="rounded-2xl bg-white shadow p-4">
                  <div className="flex items-center justify-between mb-2">
                    <h2 className="font-semibold">Agent Script (rclone‑sharedcopy‑agent.sh)</h2>
                    <div className="flex gap-2">
                      <button className="rounded-lg border px-3 py-1" onClick={()=>copy(script)}>Copy</button>
                      <button className="rounded-lg border px-3 py-1" onClick={()=>download("rclone-sharedcopy-agent.sh", script)}>Download</button>
                    </div>
                  </div>
                  <pre className="overflow-auto text-sm bg-gray-900 text-gray-100 rounded-xl p-3 whitespace-pre-wrap">{script}</pre>
                </div>

                <div className="rounded-2xl bg-white shadow p-4">
                  <div className="flex items-center justify-between mb-2">
                    <h2 className="font-semibold">LaunchAgent plist (com.rclone.sharedcopy.plist)</h2>
                    <div className="flex gap-2">
                      <button className="rounded-lg border px-3 py-1" onClick={()=>copy(plist)}>Copy</button>
                      <button className="rounded-lg border px-3 py-1" onClick={()=>download("com.rclone.sharedcopy.plist", plist)}>Download</button>
                    </div>
                  </div>
                  <pre className="overflow-auto text-sm bg-gray-900 text-gray-100 rounded-xl p-3 whitespace-pre-wrap">{plist}</pre>
                  <p className="text-xs text-gray-500 mt-2">Note: the plist uses a <code>${"${USER_HOME}"}</code> placeholder; the install one‑liner expands it to your actual home directory so LaunchAgent paths are absolute.</p>
                </div>

                <div className="rounded-2xl bg-white shadow p-4">
                  <div className="flex items-center justify-between mb-2">
                    <h2 className="font-semibold">Install One‑liner</h2>
                    <button className="rounded-lg border px-3 py-1" onClick={()=>copy(oneLiner)}>Copy</button>
                  </div>
                  <pre className="overflow-auto text-sm bg-gray-900 text-gray-100 rounded-xl p-3 whitespace-pre-wrap">{oneLiner}</pre>
                </div>

                <div className="rounded-2xl bg-white shadow p-4">
                  <div className="flex items-center justify-between mb-2">
                    <h2 className="font-semibold">Cleanup (optional)</h2>
                    <button className="rounded-lg border px-3 py-1" onClick={()=>copy(cleanup)}>Copy</button>
                  </div>
                  <pre className="overflow-auto text-sm bg-gray-900 text-gray-100 rounded-xl p-3 whitespace-pre-wrap">{cleanup}</pre>
                </div>
              </div>
            </section>

            <footer className="text-xs text-gray-500">
              <p>Security tip: Always review generated shell scripts before running. This tool keeps everything in your browser (no server involved).</p>
            </footer>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
